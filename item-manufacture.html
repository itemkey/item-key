<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Item Key — item-manufacture</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <!-- extra shop polish: product modal + gallery -->
<style>
  /* ===== Product modal (details) — responsive & no-cut ===== */
  body.modal-lock { overflow: hidden; }

  .pmodal{
    position: fixed;
    inset: 0;
    z-index: 20;
    display: grid;
    place-items: center;
    padding: clamp(10px, 2.2vw, 22px);
    background: rgba(255,255,255,.70);
    backdrop-filter: blur(6px);
  
    /* subtle gothic motion */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity .24s ease, visibility 0s linear .24s;
  }
  .pmodal[data-open="true"]{
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity .24s ease;
  }
  
    /* Key fix:
     The old gallery used aspect-ratio: 4/5, so on wide screens it became TOO TALL and got cut.
     Now the modal has a fixed viewport-based height, and the gallery scales INSIDE it. */
  .pmodal__card{
    width: min(1040px, 96vw);
    height: min(92vh, 780px);
    max-height: 92vh;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,.14);
    background: rgba(255,255,255,.95);
    display: grid;
    grid-template-rows: auto 1fr;
    min-height: 0;
  }

  .pmodal__head{
    display:flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    padding: clamp(10px, 2vh, 14px) clamp(12px, 2.4vw, 16px);
    border-bottom: 1px solid rgba(0,0,0,.08);
  }
  .pmodal__title{
    display: grid;
    gap: 6px;
  }
  .pmodal__title h3{
    margin: 0;
    font-size: 12px;
    letter-spacing: 4px;
    text-transform: uppercase;
  }
  .pmodal__title .sub{
    font-size: 10px;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: rgba(0,0,0,.55);
  }

  .pmodal__actions{
    display:flex;
    gap: 10px;
    align-items:center;
    flex: 0 0 auto;
  }

  .pmodal__body{
    padding: clamp(10px, 2.2vw, 16px);
    overflow: hidden;            /* <- no vertical scrolling in normal cases */
    display: grid;
    grid-template-columns: 1.15fr .85fr;
    gap: clamp(10px, 2vw, 16px);
    min-height: 0;
    align-items: stretch;
  }

  /* gallery */
  .gallery{
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.86);
    overflow: hidden;
    display: grid;
    grid-template-rows: 1fr auto; /* main takes remaining height */
    min-height: 0;
  }

  .gallery__main{
    /* IMPORTANT: removed aspect-ratio so it won't grow too tall on wide screens */
    border-bottom: 1px solid rgba(0,0,0,.08);
    background: linear-gradient(180deg, rgba(0,0,0,.018), transparent 60%);
    display:grid;
    place-items:center;
    min-height: 0;
    border-bottom: 1px solid rgba(0,0,0,.08);
    background: linear-gradient(180deg, rgba(0,0,0,.018), transparent 60%);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height: 0;
    overflow: hidden;
  }
  .gallery__main img{
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display:block;
  }
  .gallery__main .placeholder{
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: rgba(0,0,0,.45);
    padding: 24px 12px;
    text-align:center;
  }

  /* thumbs fit in 1–2 rows, without scrolling */
  .gallery__thumbs{
    --thumb: clamp(46px, 6.5vw, 64px);
    display:flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    overflow: hidden; /* <- no scrolling */
    border-top: 1px solid rgba(0,0,0,.05);
    background: rgba(255,255,255,.78);
    max-height: calc(var(--thumb) * 2 + 8px); /* two rows */
    align-content: flex-start;
  }
  .thumb{
    flex: 0 0 auto;
    width: var(--thumb);
    height: var(--thumb);
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.85);
    cursor: pointer;
    display:grid;
    place-items:center;
    overflow:hidden;
    user-select:none;
  }
  .thumb img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display:block;
  }
  .thumb[data-active="true"]{
    border-color: rgba(0,0,0,.26);
    background: rgba(255,255,255,.96);
  }

  /* info */
  .pinfo{
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.86);
    padding: clamp(12px, 2.2vw, 14px);
    display:grid;
    gap: 12px;
    align-content: start;
    min-height: 0;
  }
  .pinfo__top{
    display:flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 10px;
    min-width: 0;
  }
  .pinfo__price{
    font-size: 12px;
    letter-spacing: 2.2px;
    white-space: nowrap;
  }

  /* clamp description so the whole modal always fits */
  .pinfo__desc{
    margin: 0;
    font-size: clamp(11px, 1.2vw, 12.5px);
    color: rgba(0,0,0,.72);
    line-height: 1.45;
    white-space: pre-wrap;

    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 9;
    line-clamp: 9;
    overflow: hidden;
  }

  .pinfo__actions{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items:center;
    padding-top: 2px;
  }

  /* cards: strictly marketplace summary */

  /* sold out badge (grid cards) */
  .card.card--shop{ position: relative; }
  .card__badge{
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 3px 8px;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    border: 1px solid rgba(0,0,0,.16);
    background: rgba(255,255,255,.92);
    color: rgba(0,0,0,.72);
    pointer-events: none;
  }

  /* sold out label (product modal) */
  .pinfo__soldout{
    display: none;
    align-items: center;
    justify-content: center;
    padding: 10px 12px;
    border: 1px solid rgba(0,0,0,.16);
    background: rgba(255,255,255,.92);
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: rgba(0,0,0,.72);
    user-select: none;
  }

  .card.card--shop{
    cursor: pointer;
    transition: border-color .18s ease, transform .18s ease, opacity .18s ease;
  }
  .card.card--shop:hover{
    transform: translateY(-2px);
    border-color: rgba(0,0,0,.18);
    opacity: .98;
  }
  .card.card--shop .card__desc,
  .card.card--shop .card__meta,
  .card.card--shop .card__actions{
    display:none !important;
  }
  .card.card--shop .card__body{ gap: 6px; }

  /* mobile modal layout */
  @media (max-width: 980px){
    .pmodal__card{
      width: min(720px, 96vw);
      height: min(94vh, 980px);
    }
    .pmodal__body{ grid-template-columns: 1fr; }
    .pinfo__desc{ -webkit-line-clamp: 7; line-clamp: 7; }
    .gallery__thumbs{ max-height: calc(var(--thumb) * 2 + 8px); }
  }

  /* ultra-short screens: allow inner scroll to avoid any “cut” */
  @media (max-height: 560px){
    .pmodal__card{ height: 96vh; }
    .pmodal__body{ overflow: auto; } /* only here */
  }


/* ===== Gothic motion add-ons (subtle, non-intrusive) ===== */
.pmodal__card{
  transform: translateY(10px) scale(.985);
  opacity: 0;
  transition: transform .24s ease, opacity .24s ease;
  will-change: transform, opacity;
}
.pmodal[data-open="true"] .pmodal__card{
  transform: translateY(0) scale(1);
  opacity: 1;
}

/* grid + category switching */
@keyframes gridIn {
  from { opacity: 0; transform: translateY(6px); filter: blur(2px); }
  to   { opacity: 1; transform: translateY(0);   filter: blur(0); }
}
.grid.grid--anim{
  animation: gridIn .24s ease;
}

@keyframes chipSelect{
  from { transform: translateY(1px); filter: blur(1px); opacity: .86; }
  to   { transform: translateY(0);   filter: blur(0);   opacity: 1; }
}
.chip[data-active="true"]{
  animation: chipSelect .22s ease;
}

/* buttons */
@keyframes btnConfirm{
  0%   { transform: scale(1);   filter: blur(0); }
  45%  { transform: scale(1.03); filter: blur(.2px); }
  100% { transform: scale(1);   filter: blur(0); }
}
.btn.btn--added{
  animation: btnConfirm .35s ease;
}

/* cart: animate whatever base styles change (transform/opacity/etc.) */
.cart{
  transition: transform .28s ease, opacity .28s ease, filter .28s ease;
  will-change: transform, opacity;
}
@keyframes cartPulse{
  0%   { filter: blur(0); }
  55%  { filter: blur(.35px); }
  100% { filter: blur(0); }
}
.cart.cart--pulse{
  animation: cartPulse .55s ease;
}

@keyframes panelIn{
  from { opacity: 0; transform: translateY(8px); filter: blur(2px); }
  to   { opacity: 1; transform: translateY(0);  filter: blur(0); }
}
.home-panel.home--anim,
.market-toolbar.market--anim,
.chips.chips--anim{
  animation: panelIn .26s ease;
}

/* accessibility */
@media (prefers-reduced-motion: reduce){
  *, *::before, *::after{
    animation: none !important;
    transition: none !important;
    scroll-behavior: auto !important;
  }
}


/* ===== Layout immunity (no overlap with edge bars) =====
   Fixes: footer "manufacture · marketplace • pre-alpha" overlapping cards
   by reserving safe space for top/bottom edge bars on ANY screen size. */
.page-manufacture{
  --edge-top-space: clamp(56px, 7vh, 96px);
  --edge-bottom-space: clamp(56px, 7vh, 96px);
}
.page-manufacture .center-stage{
  /* keep your structure, just add safe padding so fixed bars never sit on content */
  padding-top: calc(var(--edge-top-space) + env(safe-area-inset-top, 0px)) !important;
  padding-bottom: calc(var(--edge-bottom-space) + env(safe-area-inset-bottom, 0px)) !important;
  box-sizing: border-box;
  min-height: 100svh;
}
.page-manufacture .shop-body{
  /* extra safety for long grids */
  padding-bottom: calc(var(--edge-bottom-space) + env(safe-area-inset-bottom, 0px)) !important;
}

/* If edge bars are fixed/absolute in the global CSS, keep them on top but non-destructive */
.page-manufacture .topbar.topbar--edge,
.page-manufacture .bottombar.bottombar--edge{
  z-index: 12;
}

/* Prevent text wrapping from unexpectedly growing the bottom bar into content */
.page-manufacture .bottombar .hint{
  white-space: nowrap;
}
@media (max-width: 520px){
  .page-manufacture .bottombar{
    flex-wrap: wrap;
    row-gap: 6px;
  }
  .page-manufacture .bottombar .hint{
    white-space: normal;
  }
}

/* ===== Image manager (admin) ===== */
.imgmgr{
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.86);
  padding: 12px;
  display: grid;
  gap: 10px;
}
.imgmgr__head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}
.imgmgr__title{
  font-size: 11px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: rgba(0,0,0,.75);
}
.imgmgr__actions{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items:center;
}
.imgmgr__grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(86px, 1fr));
  gap: 10px;
}
.imgtile{
  position: relative;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.90);
  overflow: hidden;
  aspect-ratio: 1 / 1;
  cursor: pointer;
  display:grid;
  place-items:center;
}
.imgtile img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display:block;
}
.imgtile__badge{
  position:absolute;
  left: 8px;
  bottom: 8px;
  padding: 2px 6px;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.92);
  color: rgba(0,0,0,.70);
}
.imgtile__remove{
  position:absolute;
  right: 6px;
  top: 6px;
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.92);
  color: rgba(0,0,0,.75);
  display:grid;
  place-items:center;
  cursor:pointer;
}
.imgtile__remove:hover{ background: rgba(255,255,255,1); }
.imgmgr__empty{
  padding: 12px 10px;
  border: 1px dashed rgba(0,0,0,.14);
  color: rgba(0,0,0,.55);
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
}


/* ===== UI Confirm modal (site-styled, replaces browser confirm) ===== */
.uimodal{
  position: fixed;
  inset: 0;
  z-index: 30;
  display: grid;
  place-items: center;
  padding: clamp(10px, 2.2vw, 22px);
  background: rgba(255,255,255,.70);
  backdrop-filter: blur(6px);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity .22s ease, visibility 0s linear .22s;
}
.uimodal[data-open="true"]{
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  transition: opacity .22s ease;
}
.uimodal__card{
  width: min(560px, 94vw);
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.95);
  overflow: hidden;
  transform: translateY(10px) scale(.985);
  opacity: 0;
  transition: transform .22s ease, opacity .22s ease;
  will-change: transform, opacity;
}
.uimodal[data-open="true"] .uimodal__card{
  transform: translateY(0) scale(1);
  opacity: 1;
}
.uimodal__head{
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap: 10px;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(0,0,0,.08);
}
.uimodal__head h3{
  margin: 0;
  font-size: 12px;
  letter-spacing: 4px;
  text-transform: uppercase;
}
.uimodal__text{
  margin: 0;
  padding: 14px;
  font-size: 12px;
  color: rgba(0,0,0,.72);
  line-height: 1.45;
}
.uimodal__actions{
  display:flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 12px 14px;
  border-top: 1px solid rgba(0,0,0,.08);
  flex-wrap: wrap;
}

/* Toast (quiet, gothic) */
.uitoast{
  position: fixed;
  left: 50%;
  bottom: clamp(14px, 3.2vh, 26px);
  transform: translateX(-50%);
  z-index: 40;
  display: grid;
  gap: 8px;
  pointer-events: none;
}
.uitoast__msg{
  pointer-events: none;
  border: 1px solid rgba(0,0,0,.14);
  background: rgba(255,255,255,.92);
  padding: 10px 12px;
  font-size: 11px;
  letter-spacing: 1.2px;
  color: rgba(0,0,0,.78);
  opacity: 0;
  transform: translateY(8px);
  filter: blur(1px);
  transition: opacity .22s ease, transform .22s ease, filter .22s ease;
}
.uitoast__msg[data-show="true"]{
  opacity: 1;
  transform: translateY(0);
  filter: blur(0);
}

</style>
</head>

<body class="page page-manufacture">
  <div class="outer-frame" aria-hidden="true"></div>
  <div class="rays" aria-hidden="true"></div>
  <div class="veil" aria-hidden="true"></div>

  <header class="topbar topbar--edge">
    <a class="toplink" href="item-user.html?returnTo=item-manufacture.html" aria-label="Item User">
      <span class="tag">item-user</span>
    </a>
  </header>

  <aside class="rail rail--left" aria-label="Левое меню">
    <a class="rail-link" href="index.html" aria-label="Вернуться в item-key"><span class="rail-link__title">item-key</span></a>
    <a class="rail-link" href="item-crate.html"><span class="rail-link__title">item-crate</span></a>
  </aside>

  <aside class="rail rail--right" aria-label="Правое меню">
    <a class="rail-link" href="item-security.html"><span class="rail-link__title">item-security</span></a>
    <a class="rail-link" href="item-soft.html"><span class="rail-link__title">item-soft</span></a>
  </aside>

  <main class="center-stage" aria-label="Marketplace">
    <section class="shop">
      <div class="shop-head">
        <div class="shop-head__inner">
          <div class="shop-title">
            <div>
              <h1>item-manufacture</h1>
              <div class="sub">marketplace · brand · guests</div>
            </div>

            <div class="controls">
              <select id="currencySelect" class="select" aria-label="Валюта">
                <option value="BYN" selected>BYN</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="RUB">RUB</option>
              </select>

              <button id="cartOpen" class="btn btn--primary" type="button">
                cart (<span id="cartCount">0</span>)
              </button>
            </div>
          </div>

          <div class="shop-tools">
            <div class="tabs" role="tablist" aria-label="Категории">
              <button class="tab" type="button" role="tab" data-tab="home" aria-selected="true">дом</button>
              <button class="tab" type="button" role="tab" data-tab="item" aria-selected="false">item</button>
              <button class="tab" type="button" role="tab" data-tab="guests" aria-selected="false">guests</button>
            </div>

            <div class="controls">
              <input id="shopSearch" class="input" type="search" placeholder="поиск (название / описание / теги)" />
            </div>
          </div>

          <div id="sectionChips" class="chips" aria-label="Разделы">
            <button class="chip" type="button" data-cat="all" data-active="true">всё</button>
            <button class="chip" type="button" data-cat="верх">верх</button>
            <button class="chip" type="button" data-cat="низ">низ</button>
            <button class="chip" type="button" data-cat="аксессуары">аксессуары</button>
            <button class="chip" type="button" data-cat="на голову">на голову</button>
          </div>
        </div>
      </div>

      <div class="shop-body">
        <!-- HOME -->
        <section id="homePanel" class="home-panel" aria-label="Дом">
          <div class="home-panel__grid">
            <div class="home-panel__left">
              <div class="home-kicker">DOM</div>
              <h2 class="home-title">Философия & история бренда</h2>
              <p class="home-lead">
                Здесь — вступление. Никаких “верх/низ/аксессуары”.
                <b>Дом</b> объясняет, что это за бренд и почему он существует.
              </p>

              <div class="home-cards">
                <div class="home-card">
                  <div class="home-card__h">История</div>
                  <div class="home-card__t">• тезис • тезис • тезис (заменишь текстом)</div>
                </div>
                <div class="home-card">
                  <div class="home-card__h">Философия</div>
                  <div class="home-card__t">• тезис • тезис • тезис (заменишь текстом)</div>
                </div>
                <div class="home-card">
                  <div class="home-card__h">Материалы</div>
                  <div class="home-card__t">• ткань / фурнитура / срок жизни • подход к качеству</div>
                </div>
                <div class="home-card">
                  <div class="home-card__h">Дропы</div>
                  <div class="home-card__t">• каждый выпуск фиксируется как документ архива</div>
                </div>
              </div>

              <div class="home-actions">
                <button class="btn btn--primary" id="goItem" type="button">open item</button>
                <button class="btn" id="goGuests" type="button">open guests</button>
              </div>

              <div class="home-note">
                Карточки по умолчанию пустые. Создавать товары можно в вкладках <b>item</b> и <b>guests</b>.
              </div>
            </div>

            <div class="home-panel__right" aria-hidden="true">
              <div class="seal">
                <div class="seal__title">ARCHIVE SEAL</div>
                <div class="seal__sigil"></div>
                <div class="seal__meta">white · gothic · marketplace</div>
              </div>
              <div class="stats">
                <div class="stat"><div class="stat__n" id="statTotal">0</div><div class="stat__l">listings</div></div>
                <div class="stat"><div class="stat__n" id="statItem">0</div><div class="stat__l">item</div></div>
                <div class="stat"><div class="stat__n" id="statGuests">0</div><div class="stat__l">guests</div></div>
              </div>
            </div>
          </div>
        </section>

        <!-- TOOLBAR visible only for item/guests -->
        <div id="marketToolbar" class="market-toolbar" style="display:none;">
          <div class="market-toolbar__left">
            <div class="market-pill" id="marketScope">scope: item</div>
          </div>
          <div class="market-toolbar__right">
            <button id="addClothBtn" class="btn btn--primary" type="button">add clothing</button>
            <button id="saveDbBtn" class="btn" type="button">save db</button>
          </div>
        </div>

        <!-- GRID -->
        <div class="grid" id="productGrid"></div>
      </div>
    </section>
  </main>

  <footer class="bottombar bottombar--edge">
    <span class="hint">manufacture · marketplace</span>
    <span class="sep">•</span>
    <span class="hint">pre-alpha</span>
  </footer>

  <!-- CART -->
  <aside class="cart" id="cart" data-open="false" aria-label="Корзина">
    <div class="cart__head">
      <div class="cart__title">
        <span>cart</span>
        <button id="cartClose" class="btn" type="button">close</button>
      </div>
    </div>
    <div class="cart__list" id="cartList"></div>
    <div class="cart__foot">
      <div class="total">
        <span>total</span>
        <span id="cartTotal">0 BYN</span>
      </div>
      <div class="helper" style="margin-top:10px;">
        Оплата/доставка: позже. Сейчас — витрина, корзина и локальная база.
      </div>
    </div>
  </aside>

  <!-- ADD CLOTHING MODAL (admin) -->
  <div class="modal" id="clothModal" data-open="false" aria-hidden="true">
    <div class="modal__card" role="dialog" aria-label="Add clothing">
      <div class="modal__head">
        <h3 id="clothModalTitle">add clothing</h3>
        <button id="clothClose" class="btn" type="button">close</button>
      </div>

      <p class="helper">
        Сейчас аккаунтов нет — считаем, что все админы. Данные пишутся в локальную базу и сохраняются между перезагрузками.
        Для “сохранения в файл” используй кнопку <b>save db</b> (создаст/обновит JSON).
      </p>

      <form id="clothForm" class="form">
        <input type="hidden" name="owner" id="clothOwner" value="item" />

        <label class="col-6">
          category
          <select class="select" name="category">
            <option value="верх">верх</option>
            <option value="низ">низ</option>
            <option value="аксессуары">аксессуары</option>
            <option value="на голову">на голову</option>
            <option value="другое">другое</option>
          </select>
        </label>

        <label class="col-6">
          price (BYN)
          <input class="input" name="price" placeholder="например: 150" />
        </label>


        <label class="col-6">
          stock
          <select class="select" name="stock">
            <option value="in" selected>in stock</option>
            <option value="soldout">sold out</option>
          </select>
        </label>

        <label class="col-12">
          name
          <input class="input" name="name" placeholder="например: KEY COAT" />
        </label>

        <label class="col-12">
          description
          <textarea class="input" name="desc" placeholder="детали, материал, посадка, смысл"></textarea>
        </label>

        <label class="col-12">
          image urls (optional, через запятую / перенос строки)
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input id="imageUrlsInput" class="input" name="imageUrls" placeholder="https://... , https://...">
            <button id="addUrlsBtn" class="btn" type="button">add urls</button>
          </div>
        </label>

        <div class="col-12">
          <div class="imgmgr" id="imgMgr" aria-label="Image files manager">
            <div class="imgmgr__head">
              <div class="imgmgr__title">image files</div>
              <div class="imgmgr__actions">
                <button id="imgBrowseBtn" class="btn" type="button">browse</button>
                <input id="imgFileInput" type="file" accept="image/*" multiple style="display:none;">
                <button id="imgClearBtn" class="btn btn--ghost" type="button">clear</button>
              </div>
            </div>
            <div class="imgmgr__hint helper">
              Можно добавлять файлы частями: нажимай <b>browse</b> сколько угодно раз.
              Нажми на превью — сделаешь его первой фоткой (cover). Крестик — удалить.
            </div>
            <div class="imgmgr__grid" id="imgPreviewGrid"></div>
          </div>
        </div>

        <div class="col-12" style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn--primary" type="submit">publish</button>
          <button id="exportDbBtn" class="btn" type="button">export json</button>
          <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
            import json
            <input id="importDbInput" type="file" accept="application/json" style="display:none;" />
          </label>
          <button id="deleteCardBtn" class="btn btn--ghost" type="button" disabled>delete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- PRODUCT DETAILS MODAL (buyers) -->
  <div class="pmodal" id="productModal" data-open="false" aria-hidden="true">
    <div class="pmodal__card" role="dialog" aria-label="Product details">
      <div class="pmodal__head">
        <div class="pmodal__title">
          <h3 id="pName">product</h3>
          <div class="sub" id="pMeta">—</div>
        </div>
        <div class="pmodal__actions">
          <button id="pEdit" class="btn" type="button">edit</button>
          <button id="pClose" class="btn" type="button">close</button>
        </div>
      </div>

      <div class="pmodal__body">
        <div class="gallery" aria-label="Gallery">
          <div class="gallery__main" id="pMainWrap">
            <div class="placeholder">image</div>
          </div>
          <div class="gallery__thumbs" id="pThumbs"></div>
        </div>

        <div class="pinfo" aria-label="Info">
          <div class="pinfo__top">
            <div class="pinfo__price" id="pPrice">0 BYN</div>
            <div class="pill" id="pCategory">—</div>
          </div>

          <p class="pinfo__desc" id="pDesc"></p>

          <div class="pinfo__actions">
            <button id="pAdd" class="btn btn--primary" type="button">add to cart</button>
            <div id="pSold" class="pinfo__soldout">sold out</div>
          </div>

          <div class="helper">
            Нажми на карточку в сетке — откроется это окно. Вся страница под ним не кликается и размыта.
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- UI CONFIRM MODAL (site-styled) -->
  <div class="uimodal" id="uiConfirm" data-open="false" aria-hidden="true">
    <div class="uimodal__card" role="dialog" aria-modal="true" aria-label="Confirm">
      <div class="uimodal__head">
        <h3 id="uiConfirmTitle">confirm</h3>
        <button id="uiConfirmClose" class="btn" type="button">close</button>
      </div>
      <p class="uimodal__text" id="uiConfirmText"></p>
      <div class="uimodal__actions">
        <button id="uiConfirmCancel" class="btn" type="button">cancel</button>
        <button id="uiConfirmOk" class="btn btn--primary" type="button">ok</button>
      </div>
    </div>
  </div>

  <!-- UI TOAST -->
  <div class="uitoast" id="uiToast" aria-live="polite" aria-atomic="true"></div>

  <script>
    // Active page highlight (simple)
    (() => {
      const path = (location.pathname.split("/").pop() || "index.html").toLowerCase();
      document.querySelectorAll("a[href]").forEach(a => {
        const href = (a.getAttribute("href") || "").toLowerCase();
        if (href === path) a.classList.add("is-active");
      });
    })();

    /* =========================
      ITEM-MANUFACTURE STORE
      - grid: ONLY (first image + name + price)
      - click card -> product modal (all images + desc + add to cart)
      - localStorage db + cart
      ========================= */
    (() => {
      if (!document.body.classList.contains("page-manufacture")) return;

      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      // UI
      const tabButtons = $$(".tab");
      const chipWrap = $("#sectionChips");
      const chipButtons = $$(".chip");
      const searchInput = $("#shopSearch");
      const currencySelect = $("#currencySelect");

      const homePanel = $("#homePanel");
      const grid = $("#productGrid");

      const toolbar = $("#marketToolbar");
      const scopePill = $("#marketScope");
      const addClothBtn = $("#addClothBtn");
      const saveDbBtn = $("#saveDbBtn");

      const goItem = $("#goItem");
      const goGuests = $("#goGuests");

      // Cart UI
      const cart = $("#cart");
      const cartOpen = $("#cartOpen");
      const cartClose = $("#cartClose");
      const cartList = $("#cartList");
      const cartCount = $("#cartCount");
      const cartTotal = $("#cartTotal");

      // Admin modal UI
      const modal = $("#clothModal");
      const modalClose = $("#clothClose");
      const form = $("#clothForm");
      const ownerHidden = $("#clothOwner");
      const exportDbBtn = $("#exportDbBtn");
      const importDbInput = $("#importDbInput");
      const deleteCardBtn = $("#deleteCardBtn");

      // Image manager (admin) UI
      const imageUrlsInput = $("#imageUrlsInput");
      const addUrlsBtn = $("#addUrlsBtn");
      const imgMgr = $("#imgMgr");
      const imgBrowseBtn = $("#imgBrowseBtn");
      const imgFileInput = $("#imgFileInput");
      const imgClearBtn = $("#imgClearBtn");
      const imgPreviewGrid = $("#imgPreviewGrid");

      // Product modal UI
      const pModal = $("#productModal");
      const pClose = $("#pClose");
      const pEdit = $("#pEdit");
      const pClose2 = $("#pClose2");
      const pName = $("#pName");
      const pMeta = $("#pMeta");
      const pPrice = $("#pPrice");
      const pCategory = $("#pCategory");
      const pDesc = $("#pDesc");
      const pThumbs = $("#pThumbs");
      const pMainWrap = $("#pMainWrap");
      const pAdd = $("#pAdd");
      const pSold = $("#pSold");

      // Stats
      const statTotal = $("#statTotal");
      const statItem = $("#statItem");
      const statGuests = $("#statGuests");

      // Keys
      const KEY_PRODUCTS = "itemkey.manufacture.products.v4";
      const KEY_CART = "itemkey.manufacture.cart.v4";
      const KEY_CURRENCY = "itemkey.manufacture.currency.v4";
      const SEED_URL = "assets/js/item-manufacture.db.json";

      const state = {
        tab: "home",
        section: "all",
        query: "",
        currency: "BYN",
        // временные курсы
        rates: { BYN: 1, USD: 0.31, EUR: 0.29, RUB: 29.0 },
        products: [],
        cart: [],
        openProductId: null,
        editProductId: null,
        galleryIndex: 0,
        draftImages: []
      };

      // ===== Site-styled confirm + toast (replaces browser alert/confirm for delete) =====
      const uiConfirmEl = $("#uiConfirm");
      const uiConfirmTitle = $("#uiConfirmTitle");
      const uiConfirmText = $("#uiConfirmText");
      const uiConfirmOk = $("#uiConfirmOk");
      const uiConfirmCancel = $("#uiConfirmCancel");
      const uiConfirmClose = $("#uiConfirmClose");
      const uiConfirmActions = uiConfirmEl?.querySelector(".uimodal__actions");
      const uiToastEl = $("#uiToast");

      let _uiConfirmResolver = null;

      function uiToast(msg, ttl = 1600){
        if (!uiToastEl) return;
        const node = document.createElement("div");
        node.className = "uitoast__msg";
        node.textContent = String(msg || "");
        uiToastEl.appendChild(node);

        // show
        requestAnimationFrame(() => node.dataset.show = "true");

        // hide + remove
        setTimeout(() => {
          node.dataset.show = "false";
          setTimeout(() => node.remove(), 260);
        }, Math.max(600, ttl));
      }

      function closeUiConfirm(result){
        if (!uiConfirmEl) return;
        uiConfirmEl.dataset.open = "false";
        uiConfirmEl.setAttribute("aria-hidden", "true");
        document.body.classList.remove("modal-lock");
        const r = _uiConfirmResolver;
        _uiConfirmResolver = null;
        if (typeof r === "function") r(!!result);
      }

      function uiConfirm({ title = "confirm", text = "", okText = "ok", cancelText = "cancel" } = {}){
        return new Promise((resolve) => {
          if (!uiConfirmEl){
            // fallback (shouldn't happen)
            resolve(false);
            return;
          }

          _uiConfirmResolver = resolve;

          if (uiConfirmTitle) uiConfirmTitle.textContent = String(title || "confirm");
          if (uiConfirmText) uiConfirmText.textContent = String(text || "");
          const _ok = (okText === undefined) ? "ok" : String(okText);
          const _cancel = (cancelText === undefined) ? "cancel" : String(cancelText);
          if (uiConfirmOk) uiConfirmOk.textContent = _ok;
          if (uiConfirmCancel) uiConfirmCancel.textContent = _cancel;
          const single = (_cancel === "" || cancelText === null);
          if (uiConfirmCancel) uiConfirmCancel.style.display = single ? "none" : "";
          if (uiConfirmActions) uiConfirmActions.style.justifyContent = single ? "flex-end" : "";

          uiConfirmEl.dataset.open = "true";
          uiConfirmEl.setAttribute("aria-hidden", "false");
          document.body.classList.add("modal-lock");

          // focus
          setTimeout(() => uiConfirmCancel?.focus?.(), 0);
        });
      }

      // confirm modal events (once)
      (() => {
        if (!uiConfirmEl) return;

        uiConfirmOk?.addEventListener("click", () => closeUiConfirm(true));
        uiConfirmCancel?.addEventListener("click", () => closeUiConfirm(false));
        uiConfirmClose?.addEventListener("click", () => closeUiConfirm(false));

        uiConfirmEl.addEventListener("click", (e) => {
          if (e.target === uiConfirmEl) closeUiConfirm(false);
        });

        document.addEventListener("keydown", (e) => {
          if (uiConfirmEl.dataset.open !== "true") return;
          if (e.key === "Escape") closeUiConfirm(false);
        });
      })();


      // UI Alert (site-styled) — replaces browser alert()
      function uiAlert({ title = "notice", text = "", okText = "ok" } = {}){
        // Uses the same modal, but with a single action button
        return uiConfirm({ title, text, okText, cancelText: "" }).then(() => {});
      }


      function uid(){
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function esc(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function normCat(c){
        return (c || "").trim().toLowerCase() || "другое";
      }

      function loadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          return JSON.parse(raw);
        }catch{ return fallback; }
      }
      function saveJSON(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }
      function persist(){
        saveJSON(KEY_PRODUCTS, state.products);
        saveJSON(KEY_CART, state.cart);
        saveJSON(KEY_CURRENCY, state.currency);
      }

      function money(amountBYN){
        const cur = state.currency;
        const rate = state.rates[cur] ?? 1;
        const v = (Number(amountBYN) || 0) * rate;
        const fmt = new Intl.NumberFormat("ru-RU", { maximumFractionDigits: cur==="RUB"?0:2 });
        return `${fmt.format(v)} ${cur}`;
      }

      function normalizeProduct(x){
        const images = Array.isArray(x?.images) ? x.images.map(String).filter(Boolean) : [];
        const legacy = String(x?.image || "").trim();
        const finalImages = images.length ? images : (legacy ? [legacy] : []);

        // stock: default in stock for old DBs
        let inStock = true;
        if (typeof x?.inStock === "boolean") inStock = x.inStock;
        else if (typeof x?.stock === "string"){
          const s = x.stock.trim().toLowerCase();
          inStock = !(s === "soldout" || s === "sold out" || s === "out" || s === "0");
        } else if (typeof x?.status === "string"){
          const s = x.status.trim().toLowerCase();
          inStock = !(s === "soldout" || s === "sold out" || s === "out");
        }

        return {
          id: String(x?.id || uid()),
          owner: (x?.owner === "guests") ? "guests" : "item",
          category: String(x?.category || "другое"),
          name: String(x?.name || "Untitled"),
          priceBYN: Number(x?.priceBYN || 0),
          inStock: !!inStock,
          images: finalImages,
          // keep legacy too (optional)
          image: finalImages[0] || "",
          desc: String(x?.desc || ""),
          createdAt: Number(x?.createdAt || Date.now())
        };
      }

      async function loadProducts(){
        const existing = loadJSON(KEY_PRODUCTS, null);
        if (Array.isArray(existing)) return existing.map(normalizeProduct);

        try{
          const res = await fetch(SEED_URL, { cache: "no-store" });
          if (!res.ok) throw new Error("seed not found");
          const data = await res.json();
          if (Array.isArray(data)) {
            const normalized = data.map(normalizeProduct);
            saveJSON(KEY_PRODUCTS, normalized);
            return normalized;
          }
        }catch{
          // ignore
        }
        return [];
      }

      function setTab(tab, opts = {}){
        // Smart no-op: clicking the active tab again does nothing
        if (!opts.force && tab === state.tab) return;
        state.tab = tab;
        state.section = "all";
        state.query = state.query || "";
        closeProductModal();

        tabButtons.forEach(b => b.setAttribute("aria-selected", b.dataset.tab === tab ? "true" : "false"));

        const isHome = (tab === "home");
        if (homePanel) homePanel.style.display = isHome ? "block" : "none";
        if (chipWrap) {
          chipWrap.style.display = isHome ? "none" : "flex";
          chipWrap.dataset.hidden = isHome ? "true" : "false";
        }
        if (toolbar) toolbar.style.display = isHome ? "none" : "flex";
        if (scopePill) scopePill.textContent = `scope: ${tab}`;
        if (ownerHidden) ownerHidden.value = tab;

        chipButtons.forEach(c => c.dataset.active = (c.dataset.cat === "all") ? "true" : "false");

        // subtle transitions on tab switch
        if (isHome) {
          kickAnim(homePanel, "home--anim");
        } else {
          kickAnim(chipWrap, "chips--anim");
          kickAnim(toolbar, "market--anim");
        }

        render();
      }

      function setSection(cat, opts = {}){
        // Smart no-op: clicking the active section again does nothing
        if (!opts.force && cat === state.section) return;
        state.section = cat;
        closeProductModal();
        chipButtons.forEach(c => c.dataset.active = (c.dataset.cat === cat) ? "true" : "false");
        kickAnim(chipWrap, "chips--anim");
        render();
      }

      function filtered(){
        const q = state.query.trim().toLowerCase();
        return state.products
          .filter(p => state.tab === "home" ? false : (p.owner === state.tab))
          .filter(p => state.section === "all" ? true : normCat(p.category) === normCat(state.section))
          .filter(p => {
            if (!q) return true;
            const hay = `${p.name} ${p.desc} ${p.category}`.toLowerCase();
            return hay.includes(q);
          });
      }

      function renderStats(){
        if (!statTotal) return;
        const total = state.products.length;
        const item = state.products.filter(p => p.owner === "item").length;
        const guests = state.products.filter(p => p.owner === "guests").length;
        statTotal.textContent = String(total);
        statItem.textContent = String(item);
        statGuests.textContent = String(guests);
      }

function kickAnim(el, cls){
  if (!el) return;
  el.classList.remove(cls);
  // force reflow to restart CSS animation
  void el.offsetWidth;
  el.classList.add(cls);
}

function animateGrid(){
  kickAnim(grid, "grid--anim");
}

function pulseCart(){
  kickAnim(cart, "cart--pulse");
}


      function cardHTML(p){
        const first = (p.images && p.images[0]) ? p.images[0] : "";
        const img = first
          ? `<img src="${esc(first)}" alt="${esc(p.name)}">`
          : `<div class="placeholder">image</div>`;

        const badge = (p.inStock === false)
          ? `<div class="card__badge">sold out</div>`
          : ``;

        // If sold out — hide price on the grid card
        const price = (p.inStock === false)
          ? ``
          : `<div class="card__price">${money(p.priceBYN)}</div>`;

        return `
          <article class="card card--shop" data-id="${esc(p.id)}" tabindex="0" role="button" aria-label="${esc(p.name)}">
            ${badge}
            <div class="card__media">${img}</div>
            <div class="card__body">
              <div class="card__top">
                <h3 class="card__name">${esc(p.name)}</h3>
                ${price}
              </div>
            </div>
          </article>
        `;
      }

      function renderGrid(){
        if (!grid) return;
        if (state.tab === "home"){
          grid.innerHTML = "";
          animateGrid();
          return;
        }

        const list = filtered();
        if (!list.length){
          grid.innerHTML = `
            <div class="empty">
              <b>пока пусто</b>
              нажми <u>add clothing</u> и создай первую карточку.
            </div>
          `;
          animateGrid();
          return;
        }

        grid.innerHTML = list.map(cardHTML).join("");
        animateGrid();
      }

      // Cart
      function openCart(on, opts = {}){
  if (!cart) return;
  const cur = cart.dataset.open === "true";
  // Smart no-op: clicking open/close when already in that state does nothing
  if (on === cur) return;

  cart.dataset.open = on ? "true" : "false";
  if (on && opts.pulse !== false) pulseCart();
}
      function cartQty(){
        return state.cart.reduce((s, x) => s + x.qty, 0);
      }
      function renderCart(){
        if (!cartCount || !cartList || !cartTotal) return;
        cartCount.textContent = String(cartQty());

        if (!state.cart.length){
          cartList.innerHTML = `<div class="helper">Корзина пуста.</div>`;
          cartTotal.textContent = money(0);
          return;
        }

        cartList.innerHTML = state.cart.map(it => {
          const p = state.products.find(x => x.id === it.id);
          if (!p) return "";
          return `
            <div class="cart-item" data-id="${esc(it.id)}">
              <div>
                <div class="cart-item__name">${esc(p.name)}</div>
                <div class="cart-item__meta">${money(p.priceBYN)} · ${esc(p.category || "—")}</div>
              </div>
              <div class="cart-item__qty">
                <button class="qtybtn" data-q="dec" type="button">−</button>
                <div>${it.qty}</div>
                <button class="qtybtn" data-q="inc" type="button">+</button>
              </div>
            </div>
          `;
        }).join("");

        const totalBYN = state.cart.reduce((sum, it) => {
          const p = state.products.find(x => x.id === it.id);
          return sum + (p ? p.priceBYN * it.qty : 0);
        }, 0);

        cartTotal.textContent = money(totalBYN);
      }

      function addToCart(id){
        const it = state.cart.find(x => x.id === id);
        if (it) it.qty += 1;
        else state.cart.push({ id, qty: 1 });
        persist();
        renderCart();
      }

      function adjustQty(id, delta){
        const it = state.cart.find(x => x.id === id);
        if (!it) return;
        it.qty += delta;
        if (it.qty <= 0) state.cart = state.cart.filter(x => x.id !== id);
        persist();
        renderCart();
      }

      // Admin modal
      function openAdminModal(on){
        if (!modal) return;
        modal.dataset.open = on ? "true" : "false";
        modal.setAttribute("aria-hidden", on ? "false" : "true");
      }

      function setAdminMode(mode, product){
        // IMPORTANT: set editProductId FIRST, then update UI (delete button state depends on it)
        if (mode !== "edit"){
          state.editProductId = null;
        } else if (product?.id){
          state.editProductId = product.id;
        }

        const titleEl = $("#clothModalTitle");
        if (titleEl){
          titleEl.textContent = (mode === "edit") ? "edit clothing" : "add clothing";
        }

        updateDeleteButton();
      }

      function setSelectValue(selectEl, value, fallback){
        if (!selectEl) return;
        const v = String(value ?? "").trim();
        const has = Array.from(selectEl.options || []).some(o => o.value === v);
        selectEl.value = has ? v : (fallback ?? selectEl.value);
      }

      function openEditorForProduct(id){
        const p = state.products.find(x => x.id === id);
        if (!p) return;

        // switch to editor mode
        setAdminMode("edit", p);

        // fill form with existing values
        try { form?.reset(); } catch {}
        if (ownerHidden) ownerHidden.value = p.owner;

        const catSel = form?.querySelector('[name="category"]');
        const stockSel = form?.querySelector('[name="stock"]');
        const priceIn = form?.querySelector('[name="price"]');
        const nameIn = form?.querySelector('[name="name"]');
        const descIn = form?.querySelector('[name="desc"]');

        // Image manager
        if (imageUrlsInput) imageUrlsInput.value = "";
        setDraftImages(Array.isArray(p.images) ? p.images : []);

        setSelectValue(catSel, p.category, "другое");
        setSelectValue(stockSel, (p.inStock === false) ? "soldout" : "in", "in");
        if (priceIn) priceIn.value = String(p.priceBYN ?? "");
        if (nameIn) nameIn.value = String(p.name ?? "");
        if (descIn) descIn.value = String(p.desc ?? "");

        openAdminModal(true);
      }

      function resetAdminModal(){
        setAdminMode("create");
        try { form?.reset(); } catch {}
        if (ownerHidden) ownerHidden.value = state.tab;
        const stockSel = form?.querySelector('[name="stock"]');
        setSelectValue(stockSel, "in", "in");
        if (imageUrlsInput) imageUrlsInput.value = "";
        setDraftImages([]);
        
        updateDeleteButton();
      }

      function readFileAsDataURL(file){
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(String(fr.result));
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }


      // ===== Image manager (admin) =====
      const IMG_LIMIT = 12;

      function uniqImages(arr){
        const out = [];
        const seen = new Set();
        for (const raw of (arr || [])){
          const s = String(raw || "").trim();
          if (!s) continue;
          if (seen.has(s)) continue;
          seen.add(s);
          out.push(s);
          if (out.length >= IMG_LIMIT) break;
        }
        return out;
      }

      function setDraftImages(images){
        state.draftImages = uniqImages(images);
        renderDraftImages();
      }

      function renderDraftImages(){
        if (!imgPreviewGrid) return;
        const imgs = state.draftImages || [];
        if (!imgs.length){
          imgPreviewGrid.innerHTML = `<div class="imgmgr__empty">no images</div>`;
          return;
        }
        imgPreviewGrid.innerHTML = imgs.map((src, i) => `
          <div class="imgtile" data-i="${i}" tabindex="0" role="button" aria-label="image ${i+1}">
            <img src="${esc(src)}" alt="image ${i+1}">
            ${i === 0 ? `<div class="imgtile__badge">cover</div>` : ``}
            <button class="imgtile__remove" type="button" data-remove="${i}" aria-label="remove">×</button>
          </div>
        `).join("");
      }

      function addUrlsToDraft(raw){
        const urls = String(raw || "")
          .split(/[,\n]+/)
          .map(s => s.trim())
          .filter(Boolean);
        if (!urls.length) return;
        setDraftImages([...(state.draftImages || []), ...urls]);
      }

      async function addFilesToDraft(fileList){
        const files = Array.from(fileList || []).filter(Boolean);
        if (!files.length) return;

        const imgs = [...(state.draftImages || [])];
        for (const f of files){
          if (imgs.length >= IMG_LIMIT) break;
          try{ imgs.push(await readFileAsDataURL(f)); }catch{}
        }
        setDraftImages(imgs);
      }

      function removeDraftImage(i){
        const imgs = [...(state.draftImages || [])];
        imgs.splice(i, 1);
        setDraftImages(imgs);
      }

      function makeCover(i){
        const imgs = [...(state.draftImages || [])];
        if (i <= 0 || i >= imgs.length) return;
        const [x] = imgs.splice(i, 1);
        imgs.unshift(x);
        setDraftImages(imgs);
      }

      async function onPublish(e){
        e.preventDefault();

        const fd = new FormData(form);
        const owner = String(fd.get("owner") || state.tab || "item");
        const category = String(fd.get("category") || "другое").trim() || "другое";
        const name = String(fd.get("name") || "").trim();
        const desc = String(fd.get("desc") || "").trim();
        const priceBYN = Number(String(fd.get("price") || "0").replace(",", "."));
        const stockRaw = String(fd.get("stock") || "in").trim().toLowerCase();
        const inStock = (stockRaw !== "soldout" && stockRaw !== "sold out" && stockRaw !== "out");

        if (!name || !Number.isFinite(priceBYN) || priceBYN <= 0){
          await uiAlert({ title: "Проверь данные", text: "Заполни название и цену (числом).", okText: "ok" });
          return;
        }

        // urls (comma/newline separated) — if user typed urls and didn't press "add urls", we still take them
        const urlsRaw = String(fd.get("imageUrls") || "");
        const urlImages = urlsRaw
          ? urlsRaw.split(/[,\n]+/).map(s => s.trim()).filter(Boolean)
          : [];

        // final images = (files added via manager) + urls
        const images = uniqImages([...(state.draftImages || []), ...urlImages]); // capped in uniqImages

        // safety cap

        const isEdit = !!state.editProductId;
        if (isEdit){
          const idx = state.products.findIndex(x => x.id === state.editProductId);
          const prev = idx >= 0 ? state.products[idx] : null;

          // In edit mode we take the current image manager state as the source of truth (can be empty if user удалил всё)
          const finalImages = images;
          const updated = normalizeProduct({
            id: prev?.id || state.editProductId,
            owner: owner === "guests" ? "guests" : "item",
            category,
            name,
            priceBYN,
            images: finalImages,
            image: finalImages[0] || "",
            desc,
            inStock,
            createdAt: prev?.createdAt || Date.now()
          });

          if (idx >= 0) state.products[idx] = updated;
          else state.products.unshift(updated);

          persist();

          form.reset();
          if (imageUrlsInput) imageUrlsInput.value = "";
          setDraftImages([]);
          state.editProductId = null;
          if (ownerHidden) ownerHidden.value = state.tab;
          openAdminModal(false);

          render();
          openProductModal(updated.id);
          return;
        }

        const product = normalizeProduct({
          id: uid(),
          owner: owner === "guests" ? "guests" : "item",
          category,
          name,
          priceBYN,
          images,
          image: images[0] || "",
          desc,
          inStock,
          createdAt: Date.now()
        });

        state.products.unshift(product);
        persist();

        form.reset();
        if (imageUrlsInput) imageUrlsInput.value = "";
        setDraftImages([]);
        if (ownerHidden) ownerHidden.value = state.tab;
        openAdminModal(false);

        render();
        openProductModal(product.id);
      }

      async function saveDbToFile(){
        const json = JSON.stringify(state.products, null, 2);

        try{
          if (window.showSaveFilePicker){
            const handle = await window.showSaveFilePicker({
              suggestedName: "item-manufacture.db.json",
              types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
            });
            const writable = await handle.createWritable();
            await writable.write(json);
            await writable.close();
            uiToast("DB сохранена в файл.");
            return;
          }
        }catch{
          // fallback below
        }

        const blob = new Blob([json], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "item-manufacture.db.json";
        a.click();
        URL.revokeObjectURL(a.href);
        uiAlert({ title: "Готово", text: "DB скачана. Положи файл в assets/js/ и замени старый.", okText: "ok" });
      }

      function exportDb(){
        const blob = new Blob([JSON.stringify(state.products, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "item-manufacture.db.json";
        a.click();
        URL.revokeObjectURL(a.href);
      }

      async function importDb(file){
        const txt = await file.text();
        const data = JSON.parse(txt);
        if (!Array.isArray(data)) throw new Error("bad db");
        state.products = data.map(normalizeProduct);
        closeProductModal();
        persist();
        render();
        uiToast("DB импортирована.");
      }

      function deleteProductById(id){
        if (!id) return false;

        // remove from products
        const before = state.products.length;
        state.products = state.products.filter(p => p.id !== id);

        // remove from cart too (so totals/count don't break)
        state.cart = state.cart.filter(it => it.id !== id);

        // close product modal if it was open for this product
        if (state.openProductId === id) closeProductModal();

        persist();
        render();
        renderCart();
        return state.products.length !== before;
      }

      function updateDeleteButton(){
        if (!deleteCardBtn) return;
        const isEdit = !!state.editProductId;
        deleteCardBtn.disabled = !isEdit;
        deleteCardBtn.textContent = isEdit ? "delete" : "delete";
        deleteCardBtn.title = isEdit ? "Удалить эту карточку" : "Удаление доступно только в режиме редактирования";
      }


      function render(){
        renderGrid();
        renderCart();
        renderStats();
        if (currencySelect) currencySelect.value = state.currency;
      }

      // ===== Product modal (details) =====
      function openProductModal(id){
        const p = state.products.find(x => x.id === id);
        if (!p || !pModal) return;

        state.openProductId = id;
        state.galleryIndex = 0;

        pName.textContent = p.name || "product";
        pMeta.textContent = `${p.owner} · ${p.category || "—"}`;

        // Price: hidden when sold out
        if (pPrice){
          if (p.inStock === false){
            pPrice.textContent = "";
            pPrice.style.display = "none";
          } else {
            pPrice.style.display = "";
            pPrice.textContent = money(p.priceBYN);
          }
        }
        pCategory.textContent = p.category || "—";
        pDesc.textContent = p.desc || "";

        // stock UI
        if (p.inStock === false){
          if (pAdd) pAdd.style.display = "none";
          if (pSold) pSold.style.display = "inline-flex";
        } else {
          if (pSold) pSold.style.display = "none";
          if (pAdd) pAdd.style.display = "";
        }

        if (pAdd){
          pAdd.disabled = false;
          pAdd.dataset.busy = "false";
          pAdd.classList.remove("btn--added");
          pAdd.textContent = "add to cart";
        }

        // thumbs + main
        const imgs = (p.images && p.images.length) ? p.images : [];
        pThumbs.innerHTML = imgs.map((src, i) => `
          <button class="thumb" type="button" data-i="${i}" data-active="${i===0 ? "true" : "false"}" aria-label="image ${i+1}">
            <img src="${esc(src)}" alt="${esc(p.name)} ${i+1}">
          </button>
        `).join("");

        setMainImage(0);

        pModal.dataset.open = "true";
        pModal.setAttribute("aria-hidden", "false");
        document.body.classList.add("modal-lock");
      }

      function closeProductModal(){
        if (!pModal) return;
        state.openProductId = null;
        state.galleryIndex = 0;
        pModal.dataset.open = "false";
        pModal.setAttribute("aria-hidden", "true");
        document.body.classList.remove("modal-lock");
      }

      function setMainImage(i){
        const p = state.products.find(x => x.id === state.openProductId);
        if (!p) return;

        const imgs = (p.images && p.images.length) ? p.images : [];
        const idx = Math.max(0, Math.min(i, Math.max(0, imgs.length - 1)));
        state.galleryIndex = idx;

        if (!imgs.length){
          pMainWrap.innerHTML = `<div class="placeholder">image</div>`;
          pThumbs.innerHTML = "";
          return;
        }

        pMainWrap.innerHTML = `<img src="${esc(imgs[idx])}" alt="${esc(p.name)}">`;
        $$(".thumb", pThumbs).forEach(t => t.dataset.active = (Number(t.dataset.i) === idx) ? "true" : "false");
      }

      // ===== Events wiring =====
      tabButtons.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));
      chipButtons.forEach(c => c.addEventListener("click", () => setSection(c.dataset.cat)));

      searchInput?.addEventListener("input", (e) => {
        state.query = e.target.value || "";
        closeProductModal();
        render();
      });

      currencySelect?.addEventListener("change", (e) => {
        state.currency = e.target.value;
        persist();
        render();
      });

      cartOpen?.addEventListener("click", () => openCart(true, { pulse: true }));
      cartClose?.addEventListener("click", () => openCart(false));

      cart?.addEventListener("click", (e) => {
        const btn = e.target.closest(".qtybtn");
        if (!btn) return;
        const row = e.target.closest(".cart-item");
        if (!row) return;
        adjustQty(row.dataset.id, btn.dataset.q === "inc" ? 1 : -1);
      });

      // Card click -> open modal
      function tryOpenFromEvent(e){
        const card = e.target.closest(".card.card--shop");
        if (!card) return;
        const id = card.dataset.id;
        openProductModal(id);
      }
      grid?.addEventListener("click", tryOpenFromEvent);

      // keyboard open on Enter/Space
      grid?.addEventListener("keydown", (e) => {
        const card = e.target.closest(".card.card--shop");
        if (!card) return;
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openProductModal(card.dataset.id);
        }
      });

      // product modal events
      pClose?.addEventListener("click", closeProductModal);
      pEdit?.addEventListener("click", () => {
        const id = state.openProductId;
        if (!id) return;
        closeProductModal();
        openEditorForProduct(id);
      });
      pClose2?.addEventListener("click", closeProductModal);
      pModal?.addEventListener("click", (e) => { if (e.target === pModal) closeProductModal(); });

      pThumbs?.addEventListener("click", (e) => {
        const t = e.target.closest(".thumb");
        if (!t) return;
        setMainImage(Number(t.dataset.i));
      });

      pAdd?.addEventListener("click", () => {
  const id = state.openProductId;
  if (!id) return;

  const p = state.products.find(x => x.id === id);
  if (p && p.inStock === false){
    uiToast("sold out");
    return;
  }

  if (pAdd.dataset.busy === "true") return;
  pAdd.dataset.busy = "true";

  // confirm click (subtle)
  pAdd.classList.add("btn--added");
  pAdd.textContent = "added ✓";
  pAdd.disabled = true;

  addToCart(id);

  // close product modal, then open cart panel
  closeProductModal();
  setTimeout(() => openCart(true, { pulse: true }), 160);

  // reset button for the next open (openProductModal also resets)
  setTimeout(() => {
    pAdd.disabled = false;
    pAdd.dataset.busy = "false";
    pAdd.classList.remove("btn--added");
    pAdd.textContent = "add to cart";
  }, 650);
});

      // Escape + arrows for gallery
      document.addEventListener("keydown", (e) => {
        if (pModal?.dataset.open !== "true") return;
        if (e.key === "Escape") closeProductModal();
        if (e.key === "ArrowLeft") setMainImage(state.galleryIndex - 1);
        if (e.key === "ArrowRight") setMainImage(state.galleryIndex + 1);
      });

      // admin modal
            addClothBtn?.addEventListener("click", () => {
        if (state.tab === "home") return;
        resetAdminModal();
        if (ownerHidden) ownerHidden.value = state.tab;
        openAdminModal(true);
      });

      saveDbBtn?.addEventListener("click", saveDbToFile);

      modalClose?.addEventListener("click", () => { openAdminModal(false); resetAdminModal(); });
      modal?.addEventListener("click", (e) => { if (e.target === modal) { openAdminModal(false); resetAdminModal(); } });

      form?.addEventListener("submit", onPublish);

      // image manager events
      imgBrowseBtn?.addEventListener("click", () => imgFileInput?.click());

      imgFileInput?.addEventListener("change", async (e) => {
        const files = e.target.files ? Array.from(e.target.files) : [];
        await addFilesToDraft(files);
        // allow selecting the same file again later
        e.target.value = "";
      });

      imgClearBtn?.addEventListener("click", () => setDraftImages([]));

      addUrlsBtn?.addEventListener("click", () => {
        addUrlsToDraft(imageUrlsInput?.value || "");
        if (imageUrlsInput) imageUrlsInput.value = "";
      });

      imgPreviewGrid?.addEventListener("click", (e) => {
        const rem = e.target.closest(".imgtile__remove");
        if (rem){
          removeDraftImage(Number(rem.dataset.remove));
          return;
        }
        const tile = e.target.closest(".imgtile");
        if (!tile) return;
        makeCover(Number(tile.dataset.i));
      });

      imgPreviewGrid?.addEventListener("keydown", (e) => {
        const tile = e.target.closest(".imgtile");
        if (!tile) return;
        if (e.key === "Enter" || e.key === " "){
          e.preventDefault();
          makeCover(Number(tile.dataset.i));
        }
      });

      exportDbBtn?.addEventListener("click", exportDb);
      importDbInput?.addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try{ await importDb(f); }catch{ await uiAlert({ title: "Ошибка", text: "Ошибка импорта.", okText: "ok" }); }
        importDbInput.value = "";
      });
      
      deleteCardBtn?.addEventListener("click", async () => {
        if (!state.editProductId) return;
        const id = state.editProductId;
        const p = state.products.find(x => x.id === id);
        const name = p?.name ? `“${p.name}”` : "эту карточку";

        const yes = await uiConfirm({
          title: "delete",
          text: `Удалить ${name}? Это действие нельзя отменить.`,
          okText: "delete",
          cancelText: "cancel"
        });
        if (!yes) return;

        const ok = deleteProductById(id);
        // close editor either way
        openAdminModal(false);
        resetAdminModal();

        if (ok) uiToast("Карточка удалена.");
      });


      goItem?.addEventListener("click", () => setTab("item"));
      goGuests?.addEventListener("click", () => setTab("guests"));

      // ===== init =====
      state.cart = loadJSON(KEY_CART, []);
      state.currency = loadJSON(KEY_CURRENCY, "BYN") || "BYN";

      (async () => {
        state.products = await loadProducts();
        setTab("home", { force: true });
})();
    })();

/* =========================
  NAV: remember where item-user was opened from
  - Writes several keys for compatibility
  - Also navigates with ?from=<page>&returnTo=<page>
  ========================= */
(() => {
  const from = (location.pathname.split("/").pop() || "index.html");

  const RETURN_KEYS = [
    "itemkey.user.returnTo",
    "itemkey.lastPage",
    "itemkey.returnTo",
    "itemkey.prevPage",
    "itemkey.nav.return",
    "itemkey.user.from"
  ];

  const setAll = (v) => {
    try{
      RETURN_KEYS.forEach(k => localStorage.setItem(k, v));
      sessionStorage.setItem("itemkey.user.returnTo", v);
    }catch{}
  };

  // store on load too (so item-user can read even if user typed URL manually)
  setAll(from);

  const userLink = document.querySelector('a.toplink[href^="item-user.html"]');
  if (!userLink) return;

  userLink.addEventListener("click", (e) => {
    e.preventDefault();
    setAll(from);

    const url = new URL(userLink.getAttribute("href") || "item-user.html", location.href);
    url.searchParams.set("from", from);
    url.searchParams.set("returnTo", from);

    // navigate (keep filename only, like the rest of the site)
    location.href = url.pathname.split("/").pop() + "?" + url.searchParams.toString() + url.hash;
  });
})();

/* =========================
      ITEM-USER HEADER LABEL
      показывает @login когда пользователь вошёл
      ========================= */
    (() => {
      const CURRENT_KEY = "itemkey.currentUser";
      let current = null;
      try { current = JSON.parse(localStorage.getItem(CURRENT_KEY) || "null"); } catch { current = null; }

      const userLink = document.querySelector('a.toplink[href^="item-user.html"]');
      if (!userLink) return;

      const tag = userLink.querySelector(".tag");
      if (!tag) return;

      if (current && current.name) {
        tag.textContent = `item-user · @${current.name}`;
        userLink.setAttribute("aria-label", `Item User ${current.name}`);
      } else {
        tag.textContent = "item-user";
        userLink.setAttribute("aria-label", "Item User");
      }
    })();
  </script>
</body>
</html>
